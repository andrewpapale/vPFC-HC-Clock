# 2024-07-13 AndyP
# Do Lose-Stay Higher Entropy Modulation of AH-DMN activity SLRS predict higher EV/Vmax choices?

library(tidyverse)
library(ggplot2)
library(stringr)
library(pracma)

repo_directory <- "~/clock_analysis"
HC_cache_dir = '~/vmPFC/MEDUSA Schaefer Analysis'
vmPFC_cache_dir = '~/vmPFC/MEDUSA Schaefer Analysis'
ncores <- 26
toalign <- 'clock'
do_vif = FALSE
do_exploit_3way = FALSE
plot_exploit_3way = FALSE
do_pred_Vmax = FALSE
plot_pred_Vmax = FALSE
do_pred_EV = TRUE
plot_pred_EV = TRUE
do_pred_points = FALSE
std_of_subject_level_rand_slope = 1;

if (do_exploit_3way){
  
  source("~/fmri.pipeline/R/mixed_by.R")
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-ranslopes-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  qdf <- qdf %>% rename(id=level)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf$id <- as.character(qdf$id)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory=repo_directory,dataset='mmclock_fmri')
  df <- df %>% select(rt_vmax_lag,iti_prev,ev,iti_ideal,score_csv,v_max,outcome,v_entropy,rt_lag,v_entropy_full,v_entropy_wi_full,rt_vmax_full,rt_vmax_change_full,rt_csv_sc,rt_csv,id, run, run_trial, last_outcome, trial_neg_inv_sc,pe_max, rt_vmax, score_csv,
                      v_max_wi, v_entropy_wi,kld4_lag,kld4,rt_change,total_earnings, rewFunc,rt_csv, pe_max,v_chosen,rewFunc,iti_ideal,
                      rt_vmax_lag_sc,rt_vmax_change,outcome,pe_max,kld3_lag,rt_lag_sc,rt_next,v_entropy_wi_change,pe_max_lag) %>% 
    group_by(id, run) %>% 
    mutate(iti_lag = lag(iti_ideal), rt_sec = rt_csv/1000) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           iti_sc = scale(iti_ideal),
           iti_prev_sc = scale(iti_prev),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_max_wi_lag = lag(v_max_wi),
           v_entropy_sc = scale(v_entropy),
           v_max_lag_sc = scale(lag(v_max)),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 15 ~ 'Early',
    run_trial > 15 & run_trial < 30 ~ 'Middle',
    run_trial >=30 ~ 'Late',
  )))
  
  df$id <- as.character(df$id)
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)
  #~ (trial_neg_inv + rt_lag + v_max_wi_lag + v_entropy_wi + fmri_beta + last_outcome)^2 +
  #  rt_lag:last_outcome:fmri_beta +
  #  rt_vmax_lag*trial_neg_inv*fmri_beta +
  #  (1 | id/run)
  decode_formula <- NULL
  #decode_formula[[1]] = formula(~ rt_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 | id/run))
  #decode_formula[[2]] = formula(~ rt_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 + rt_lag_sc | id/run))
  #decode_formula[[3]] = formula(~ rt_vmax_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 | id/run))  
  #decode_formula[[4]] = formula(~ rt_vmax_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 + rt_vmax_lag_sc | id/run))   
  
  decode_formula[[1]] <- formula(~(rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * subj_level_rand_slope * last_outcome + (1 | id/run))
  #decode_formula[[2]] <- formula(~(trial_neg_inv_sc + rt_lag_sc + v_max_wi_lag + v_entropy_wi + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * trial_neg_inv_sc * subj_level_rand_slope + (1 + rt_vmax_lag_sc + rt_lag_sc | id/run))
  
  qVL <- quantile(df$v_max_wi_lag,c(0.1,0.9),na.rm=TRUE)
  qRTV <- quantile(df$rt_vmax_lag,c(0.1,0.9),na.rm=TRUE)
  qH <- NULL
  qH[1] <- mean(df$v_entropy_wi,na.rm=TRUE) - 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qH[2] <- mean(df$v_entropy_wi,na.rm=TRUE) + 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRT <- quantile(df$rt_lag_sc,c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  #qH <- c(1,2,3,4)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRS <- quantile(Q2$estimate, c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  splits = c('HC_region','network')
  source('~/fmri.pipeline/R/mixed_by.R')
  for (j in 1:length(decode_formula)){
    
    ddq <- mixed_by(Q2, outcomes = "rt_csv_sc", rhs_model_formulae = decode_formula[[j]], split_on = splits,return_models=TRUE,
                    padjust_by = "term", padjust_method = "fdr", ncores = ncores, refit_on_nonconvergence = 3,
                    tidy_args = list(effects=c("fixed","ran_vals"),conf.int=TRUE),
                    emmeans_spec = list(
                      RT = list(outcome='rt_csv_sc', model_name='model1', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='rt_csv_sc', model_name='model1', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='rt_csv_sc',model_name='model1',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),        
                      RTVxO = list(outcome='rt_csv_sc',model_name='model1',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2)))
                      
                    ),
                    emtrends_spec = list(
                      RT = list(outcome='rt_csv_sc', model_name='model1', var='rt_lag_sc', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='rt_csv_sc', model_name='model1', var='rt_vmax_lag_sc', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='rt_csv_sc',model_name='model1',var='rt_lag_sc',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTVxO = list(outcome='rt_csv_sc',model_name='model1', var = 'rt_vmax_lag_sc',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2)))#,
                      # TrxVmax1 = list(outcome='rt_csv',model_name='model1', var = 'trial_neg_inv_sc',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      # TrxVmax2 = list(outcome='rt_csv',model_name='model1', var = 'subj_level_rand_slope',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(rt_vmax_lag_sc=c(-2,-1,0,1,2),trial_neg_inv_sc=c(-0.9,-0.02,0.2,0.34,0.4)))
                    )
    )
    setwd('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection')
    curr_date <- strftime(Sys.time(),format='%Y-%m-%d')
    if (j==1){
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-pred-int-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata'))
    } else {
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-pred-slo-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata')) 
    }
    
    
    if (do_vif){
      nHC = unique(Q2$HC_region)
      nN = unique(Q2$network)
      vdf <- NULL
      network <- NULL
      HC_region <- NULL
      for (iHC in 1:length(nHC)){
        for (iN in 1:length(nN)){
          temp <- Q2 %>% filter(HC_region == nHC[iHC])
          temp <- temp %>% filter(network == nN[iN])
          m1 <- lmerTest::lmer(data=temp, rt_csv_sc ~(rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * trial_neg_inv_sc * subj_level_rand_slope + (1 | id/run))
          v0 <- car::vif(m1)
          vdf <- rbind(vdf,v0)
          network <- rbind(network,nN[iN])
          HC_region <- rbind(HC_region,nHC[iHC])
        }
      }
      vdf1 <- data.frame(vdf,network=network,HC_regio=HC_region)
    }
  } 
  
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-ranslopes-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  
  ### Does random slope predict rt_vmax or rt_swing?
  rm(Q2)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  #qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf <- qdf %>% rename(id=level)
  qdf$id <- as.character(qdf$id)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory=repo_directory,dataset='mmclock_meg')
  df <- df %>% select(rt_vmax_lag,iti_prev,ev,score_csv,v_max,outcome,v_entropy,rt_lag,v_entropy_full,v_entropy_wi_full,rt_vmax_full,rt_vmax_change_full,rt_csv_sc,rt_csv,id, run, run_trial, last_outcome, trial_neg_inv_sc,pe_max, rt_vmax, score_csv,
                      v_max_wi, v_entropy_wi,kld4_lag,kld4,rt_change,total_earnings, rewFunc,rt_csv, pe_max,v_chosen,rewFunc,
                      rt_vmax_lag_sc,rt_vmax_change,outcome,pe_max,kld3_lag,rt_lag_sc,rt_next,v_entropy_wi_change,pe_max_lag) %>% 
    group_by(id, run) %>% 
    mutate(rt_sec = rt_csv/1000) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_entropy_sc = scale(v_entropy),
           v_max_wi_lag = lag(v_max_wi),
           v_max_lag_sc = scale(lag(v_max)),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 15 ~ 'Early',
    run_trial > 15 & run_trial < 30 ~ 'Middle',
    run_trial >=30 ~ 'Late',
  )))
  
  df$id <- as.character(df$id)
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)
  #~ (trial_neg_inv + rt_lag + v_max_wi_lag + v_entropy_wi + fmri_beta + last_outcome)^2 +
  #  rt_lag:last_outcome:fmri_beta +
  #  rt_vmax_lag*trial_neg_inv*fmri_beta +
  #  (1 | id/run)
  decode_formula <- NULL
  decode_formula[[1]] <- formula(~( rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * subj_level_rand_slope * last_outcome + (1 | id/run))
  #decode_formula[[2]] <- formula(~(trial_neg_inv_sc + rt_lag_sc + v_max_wi_lag + v_entropy_wi + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * trial_neg_inv_sc * subj_level_rand_slope + (1 + rt_vmax_lag_sc + rt_lag_sc | id/run))
  qVL <- quantile(df$v_max_wi_lag,c(0.1,0.9),na.rm=TRUE)
  qRTV <- quantile(df$rt_vmax_lag,c(0.1,0.9),na.rm=TRUE)
  qH <- NULL
  qH[1] <- mean(df$v_entropy_wi,na.rm=TRUE) - 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qH[2] <- mean(df$v_entropy_wi,na.rm=TRUE) + 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRT <- quantile(df$rt_lag_sc,c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  #qH <- c(1,2,3,4)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRS <- quantile(Q2$estimate, c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  splits = c('HC_region','network')
  source('~/fmri.pipeline/R/mixed_by.R')
  for (j in 1:length(decode_formula)){
    ddq <- mixed_by(Q2, outcomes = "rt_csv_sc", rhs_model_formulae = decode_formula[[j]], split_on = splits,return_models=TRUE,
                    padjust_by = "term", padjust_method = "fdr", ncores = ncores, refit_on_nonconvergence = 3,
                    tidy_args = list(effects=c("fixed","ran_vals"),conf.int=TRUE),
                    emmeans_spec = list(
                      RT = list(outcome='rt_csv_sc', model_name='model1', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='rt_csv_sc', model_name='model1', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='rt_csv_sc',model_name='model1',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),        
                      RTVxO = list(outcome='rt_csv_sc',model_name='model1',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2)))
                      
                    ),
                    emtrends_spec = list(
                      RT = list(outcome='rt_csv_sc', model_name='model1', var='rt_lag_sc', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='rt_csv_sc', model_name='model1', var='rt_vmax_lag_sc', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='rt_csv_sc',model_name='model1',var='rt_lag_sc',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTVxO = list(outcome='rt_csv_sc',model_name='model1', var = 'rt_vmax_lag_sc',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2)))#,
                      # TrxVmax1 = list(outcome='rt_csv',model_name='model1', var = 'trial_neg_inv_sc',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      # TrxVmax2 = list(outcome='rt_csv',model_name='model1', var = 'subj_level_rand_slope',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(rt_vmax_lag_sc=c(-2,-1,0,1,2),trial_neg_inv_sc=c(-0.9,-0.02,0.2,0.34,0.4)))
                    )
    )
    setwd('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection')
    curr_date <- strftime(Sys.time(),format='%Y-%m-%d')
    if (j==1){
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-replication-pred-int-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata'))
    } else {
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-replication-pred-slo-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata')) 
    } 
  }
  
  
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-Explore-ranslopes-HConly-trial_mod-trial1-10included-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  
  ### Does random slope predict rt_vmax or rt_swing?
  rm(Q2)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  
  #qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf <- qdf %>% rename(id=level)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf$id <- as.character(qdf$id)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory='/Volumes/Users/Andrew/MEDuSA_data_Explore',dataset='explore')
  df <- df %>%
    group_by(id,run_number) %>%
    arrange(id, run_number, trial) %>%
    mutate(condition_trial = run_trial-floor(run_trial/40.5)*40,
           condition_trial_neg_inv = -1000 / condition_trial,
           condition_trial_neg_inv_sc = as.vector(scale(condition_trial_neg_inv)),
    ) %>% ungroup()
  df <- df %>%
    group_by(id) %>% 
    mutate(v_entropy_sc_r = scale(v_entropy)) %>% ungroup() %>%
    group_by(id, run) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           iti_sc = scale(iti_ideal),
           iti_lag_sc = lag(iti_sc),
           v_chosen_sc = scale(v_chosen),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_entropy_sc = scale(v_entropy),
           v_max_lag_sc = scale(lag(v_max)),
           v_max_wi_lag = lag(v_max_wi),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           abs_rt_vmax_change = abs(rt_vmax_change),
           rt_vmax_change_bin = case_when(
             abs_rt_vmax_change < 4/24 ~ 'No Change',
             abs_rt_vmax_change >= 4/24 ~ 'Change'
           ),
           v_entropy_wi_change_bin = case_when(
             v_entropy_wi_change < -0.5 ~ 'Decrease',
             v_entropy_wi_change > 0.5  ~ 'Increase',
             v_entropy_wi_change >= -0.5 & v_entropy_wi_change <= 0.5 ~ 'No Change'
           ),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 13 ~ 'Early',
    run_trial > 13 & run_trial < 26 ~ 'Middle',
    run_trial >=26 ~ 'Late',
  )))
  df <- df %>% mutate(total_earnings_split = case_when(total_earnings >= median(df$total_earnings,na.rm=TRUE)~'richer',
                                                       total_earnings < median(df$total_earnings,na.rm=TRUE)~'poorer'))
  
  df <- df %>% select(total_earnings_split,v_max_wi_lag,rt_vmax_lag_sc,condition_trial_neg_inv_sc,iti_ideal,rt_lag_sc,iti_lag_sc,iti_prev,iti_sc,v_entropy_wi_change_lag,outcome,ev_sc,v_chosen_sc,last_outcome,rt_csv,rt_bin,rt_vmax_change_sc,trial_bin,rt_csv_sc,run_trial,id,run,v_entropy_wi,v_max_wi,trial_neg_inv_sc,trial,rewFunc)
  df$id <- as.character(df$id)
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)
  Q2 <- Q2 %>% mutate(run_trial0 = case_when(trial <= 40 ~ trial, 
                                             trial > 40 & trial <= 80 ~ trial-40,
                                             trial > 80 & trial <=120 ~ trial-80, 
                                             trial > 120 & trial <=160 ~ trial-120,
                                             trial > 160 & trial <=200 ~ trial-160,
                                             trial > 200 & trial <=240 ~ trial-200))
  Q2 <- Q2 %>% mutate(run_trial0_c = run_trial-floor(run_trial/40.5)*40,
                      run_trial0_neg_inv = -1000 / run_trial0_c,
                      run_trial0_neg_inv_sc = as.vector(scale(run_trial0_neg_inv))
  )
  #~ (trial_neg_inv + rt_lag + v_max_wi_lag + v_entropy_wi + fmri_beta + last_outcome)^2 +
  #  rt_lag:last_outcome:fmri_beta +
  #  rt_vmax_lag*trial_neg_inv*fmri_beta +
  #  (1 | id/run)
  decode_formula <- NULL
  decode_formula[[1]] <- formula(~(rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * subj_level_rand_slope*last_outcome + (1 | id/run))
  qH <- NULL
  qH[1] <- mean(df$v_entropy_wi,na.rm=TRUE) - 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qH[2] <- mean(df$v_entropy_wi,na.rm=TRUE) + 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRT <- quantile(df$rt_lag_sc,c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  #qH <- c(1,2,3,4)
  qT <- quantile(df$condition_trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  splits = c('HC_region','network')
  source('~/fmri.pipeline/R/mixed_by.R')
  for (j in 1:length(decode_formula)){
    ddq <- mixed_by(Q2, outcomes = "rt_csv_sc", rhs_model_formulae = decode_formula[[j]], split_on = splits,return_models=TRUE,
                    padjust_by = "term", padjust_method = "fdr", ncores = ncores, refit_on_nonconvergence = 3,
                    tidy_args = list(effects=c("fixed","ran_vals"),conf.int=TRUE),
                    emmeans_spec = list(
                      RT = list(outcome='rt_csv_sc', model_name='model1', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='rt_csv_sc', model_name='model1', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='rt_csv_sc',model_name='model1',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),        
                      RTVxO = list(outcome='rt_csv_sc',model_name='model1',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2)))
                      
                    ),
                    emtrends_spec = list(
                      RT = list(outcome='rt_csv_sc', model_name='model1', var='rt_lag_sc', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='rt_csv_sc', model_name='model1', var='rt_vmax_lag_sc', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='rt_csv_sc',model_name='model1',var='rt_lag_sc',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTVxO = list(outcome='rt_csv_sc',model_name='model1', var = 'rt_vmax_lag_sc',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2)))#,
                      # TrxVmax1 = list(outcome='rt_csv',model_name='model1', var = 'trial_neg_inv_sc',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      # TrxVmax2 = list(outcome='rt_csv',model_name='model1', var = 'subj_level_rand_slope',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(rt_vmax_lag_sc=c(-2,-1,0,1,2),trial_neg_inv_sc=c(-0.9,-0.02,0.2,0.34,0.4)))
                    )
    )
    setwd('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection')
    curr_date <- strftime(Sys.time(),format='%Y-%m-%d')
    if (j==1){
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-Explore-ranslopes-',toalign,'-pred-int-trial_mod-trial1-10included-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata'))
    } else {
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-Explore-ranslopes-',toalign,'-pred-slo-trial_mod-trial1-10included-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata')) 
    }
    
    if (do_vif){
      nHC = unique(Q2$HC_region)
      nN = unique(Q2$network)
      vdf <- NULL
      network <- NULL
      HC_region <- NULL
      for (iHC in 1:length(nHC)){
        for (iN in 1:length(nN)){
          temp <- Q2 %>% filter(HC_region == nHC[iHC])
          temp <- temp %>% filter(network == nN[iN])
          m1 <- lmerTest::lmer(data=temp, rt_csv ~ (rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * subj_level_rand_slope * last_outcome + (1 | id/run))
          v0 <- car::vif(m1)
          vdf <- rbind(vdf,v0)
          network <- rbind(network,nN[iN])
          HC_region <- rbind(HC_region,nHC[iHC])
        }
      }
      vdf2 <- data.frame(vdf,network=network,HC_regio=HC_region)
    }
    
  }
} 

if (plot_exploit_3way){
  
  # model iterations 1=HC_within:v_entropy, 2=HC_within:v_max_wi, 3=HC_within (not currently reported)
  load('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/2024-07-13-vmPFC-HC-network-ranslopes-clock-pred-int-notimesplit-nofixedeffect-exploit3way-1.Rdata')
  emt_mmclock_fmri <- ddq$emtrends_list
  load('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/2024-07-13-vmPFC-HC-network-ranslopes-clock-replication-pred-int-notimesplit-nofixedeffect-exploit3way-1.Rdata')
  emt_mmclock_meg <- ddq$emtrends_list
  load('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/2024-07-13-vmPFC-HC-network-Explore-ranslopes-clock-pred-int-trial_mod-trial1-10included-notimesplit-nofixedeffect-exploit3way-1.Rdata')
  emt_explore <- ddq$emtrends_list
  
  
  RTxO_mmclock_fmri <- emt_mmclock_fmri$RTxO %>% mutate(dataset = 'Experiment 1 fMRI')
  RTxO_mmclock_meg <- emt_mmclock_meg$RTxO %>% mutate(dataset = 'Experiment 1 MEG')
  RTxO_explore <- emt_explore$RTxO %>% mutate(dataset = 'Experiment 2')
  
  PH_mmclock_fmri <- RTxO_mmclock_fmri %>% filter(HC_region == 'PH')
  PH_mmclock_meg <- RTxO_mmclock_meg %>% filter(HC_region == 'PH')
  PH_explore <- RTxO_explore %>% filter(HC_region == 'PH')
  
  AH_mmclock_fmri <- RTxO_mmclock_fmri %>% filter(HC_region == 'AH')
  AH_mmclock_meg <- RTxO_mmclock_meg %>% filter(HC_region == 'AH')
  AH_explore <- RTxO_explore %>% filter(HC_region == 'AH')
  
  PH_merged <- rbind(PH_mmclock_fmri,PH_mmclock_meg)
  PH_merged <- rbind(PH_merged, PH_explore)
  
  AH_merged <- rbind(AH_mmclock_fmri, AH_mmclock_meg)
  AH_merged <- rbind(AH_merged, AH_explore)
  
  
  PH_merged <- PH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  PH_merged <- PH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  PH_merged$subj_level_rand_slope <- as.factor(PH_merged$subj_level_rand_slope)
  PH_merged <- PH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  PH_merged <- PH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  AH_merged <- AH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  AH_merged <- AH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  AH_merged$subj_level_rand_slope <- as.factor(AH_merged$subj_level_rand_slope)
  AH_merged <- AH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  AH_merged <- AH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  
  AH_summary <- AH_merged %>% 
    group_by(dataset,network,last_outcome,entropy) %>% 
    summarize(mean_trend = mean(rt_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  PH_summary <- PH_merged %>% 
    group_by(dataset,network,last_outcome,entropy) %>% 
    summarize(mean_trend = mean(rt_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  
  
  library(wesanderson)
  pal3 = wes_palette("FantasticFox1", 3, type = "discrete")
  pal = palette()
  pal[1] = pal3[2]
  pal[2] = pal3[1]
  pal[3] = pal3[3]
  
  pdf('RT-Pred-Entropy-AH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(AH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(last_outcome~dataset,labeller = label_wrap_gen(width=16), scales='free_y') + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    xlab('Network') +
    ggtitle('Anterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  pdf('RT-Pred-Entropy-PH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(PH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(last_outcome~dataset,labeller = label_wrap_gen(width=16), scales='free_y') + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    xlab('Network') +
    ggtitle('Posterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  
  RT_mmclock_fmri <- emt_mmclock_fmri$RT %>% mutate(dataset = 'Experiment 1 fMRI')
  RT_mmclock_meg <- emt_mmclock_meg$RT %>% mutate(dataset = 'Experiment 1 MEG')
  RT_explore <- emt_explore$RT %>% mutate(dataset = 'Experiment 2')
  
  PH_mmclock_fmri <- RT_mmclock_fmri %>% filter(HC_region == 'PH')
  PH_mmclock_meg <- RT_mmclock_meg %>% filter(HC_region == 'PH')
  PH_explore <- RT_explore %>% filter(HC_region == 'PH')
  
  AH_mmclock_fmri <- RT_mmclock_fmri %>% filter(HC_region == 'AH')
  AH_mmclock_meg <- RT_mmclock_meg %>% filter(HC_region == 'AH')
  AH_explore <- RT_explore %>% filter(HC_region == 'AH')
  
  PH_merged <- rbind(PH_mmclock_fmri,PH_mmclock_meg)
  PH_merged <- rbind(PH_merged, PH_explore)
  
  AH_merged <- rbind(AH_mmclock_fmri, AH_mmclock_meg)
  AH_merged <- rbind(AH_merged, AH_explore)
  
  
  PH_merged <- PH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  PH_merged <- PH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  PH_merged$subj_level_rand_slope <- as.factor(PH_merged$subj_level_rand_slope)
  PH_merged <- PH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  PH_merged <- PH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  AH_merged <- AH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  AH_merged <- AH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  AH_merged$subj_level_rand_slope <- as.factor(AH_merged$subj_level_rand_slope)
  AH_merged <- AH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  AH_merged <- AH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  
  AH_summary <- AH_merged %>% 
    group_by(dataset,network,entropy) %>% 
    summarize(mean_trend = mean(rt_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  PH_summary <- PH_merged %>% 
    group_by(dataset,network,entropy) %>% 
    summarize(mean_trend = mean(rt_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  
  
  library(wesanderson)
  pal3 = wes_palette("FantasticFox1", 3, type = "discrete")
  pal = palette()
  pal[1] = pal3[2]
  pal[2] = pal3[1]
  pal[3] = pal3[3]
  
  pdf('RT-2way-Pred-Entropy-AH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(AH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(~dataset,labeller = label_wrap_gen(width=16)) + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    ggtitle('Anterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  pdf('RT-2way-Pred-Entropy-PH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(PH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(~dataset,labeller = label_wrap_gen(width=16)) + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    ggtitle('Posterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  # RTdmm$p_level_fdr <- factor(RTdmm$p_level_fdr, levels = c('1', '2', '3', '4'), labels = c("NS","p < .05", "p < .01", "p < .001"))
  # ggplot(RTdmm, aes(x=evt_time,y=rt_lag_sc.trend,color=entropy,group=entropy,ymin=rt_lag_sc.trend-std.error,ymax=rt_lag_sc.trend+std.error)) + 
  #   geom_point(size=3) + geom_line(size=1) +
  #   geom_errorbar(width=0.5) + scale_y_reverse() + facet_grid(last_outcome~HC_region) +
  #   ylab('<--- less --- Exploration --- more --->') + ggtitle('DMN emtrend')
  # #ggtitle('Exploration occurs when DMN-HC Connectivity is \n More Modulated by Entropy')
  
  
  RTvmax_mmclock_fmri <- emt_mmclock_fmri$Vmax %>% mutate(dataset = 'Experiment 1 fMRI')
  RTvmax_mmclock_meg <- emt_mmclock_meg$Vmax %>% mutate(dataset = 'Experiment 1 MEG')
  RTvmax_explore <- emt_explore$Vmax %>% mutate(dataset = 'Experiment 2')
  
  PH_mmclock_fmri <- RTvmax_mmclock_fmri %>% filter(HC_region == 'PH')
  PH_mmclock_meg <- RTvmax_mmclock_meg %>% filter(HC_region == 'PH')
  PH_explore <- RTvmax_explore %>% filter(HC_region == 'PH')
  
  AH_mmclock_fmri <- RTvmax_mmclock_fmri %>% filter(HC_region == 'AH')
  AH_mmclock_meg <- RTvmax_mmclock_meg %>% filter(HC_region == 'AH')
  AH_explore <- RTvmax_explore %>% filter(HC_region == 'AH')
  
  PH_merged <- rbind(PH_mmclock_fmri,PH_mmclock_meg)
  PH_merged <- rbind(PH_merged, PH_explore)
  
  AH_merged <- rbind(AH_mmclock_fmri, AH_mmclock_meg)
  AH_merged <- rbind(AH_merged, AH_explore)
  
  
  PH_merged <- PH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  PH_merged <- PH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  PH_merged$subj_level_rand_slope <- as.factor(PH_merged$subj_level_rand_slope)
  PH_merged <- PH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  PH_merged <- PH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  AH_merged <- AH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  AH_merged <- AH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  AH_merged$subj_level_rand_slope <- as.factor(AH_merged$subj_level_rand_slope)
  AH_merged <- AH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  AH_merged <- AH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  
  AH_summary <- AH_merged %>% 
    group_by(dataset,network,entropy) %>% 
    summarize(mean_trend = mean(rt_vmax_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  PH_summary <- PH_merged %>% 
    group_by(dataset,network,entropy) %>% 
    summarize(mean_trend = mean(rt_vmax_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  
  
  library(wesanderson)
  pal3 = wes_palette("FantasticFox1", 3, type = "discrete")
  pal = palette()
  pal[1] = pal3[2]
  pal[2] = pal3[1]
  pal[3] = pal3[3]
  
  pdf('RTvmax-2way-Pred-Entropy-AH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(AH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(~dataset,labeller = label_wrap_gen(width=16)) + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploitation - more ->') +
    theme_bw(base_size=13) +
    ggtitle('Anterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  pdf('RTvmax-2way-Pred-Entropy-PH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(PH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(~dataset,labeller = label_wrap_gen(width=16)) + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploitation - more ->') +
    theme_bw(base_size=13) +
    ggtitle('Posterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  
  
  RTVxO_mmclock_fmri <- emt_mmclock_fmri$RTVxO %>% mutate(dataset = 'Experiment 1 fMRI')
  RTVxO_mmclock_meg <- emt_mmclock_meg$RTVxO %>% mutate(dataset = 'Experiment 1 MEG')
  RTVxO_explore <- emt_explore$RTVxO %>% mutate(dataset = 'Experiment 2')
  
  PH_mmclock_fmri <- RTVxO_mmclock_fmri %>% filter(HC_region == 'PH')
  PH_mmclock_meg <- RTVxO_mmclock_meg %>% filter(HC_region == 'PH')
  PH_explore <- RTVxO_explore %>% filter(HC_region == 'PH')
  
  AH_mmclock_fmri <- RTVxO_mmclock_fmri %>% filter(HC_region == 'AH')
  AH_mmclock_meg <- RTVxO_mmclock_meg %>% filter(HC_region == 'AH')
  AH_explore <- RTVxO_explore %>% filter(HC_region == 'AH')
  
  PH_merged <- rbind(PH_mmclock_fmri,PH_mmclock_meg)
  PH_merged <- rbind(PH_merged, PH_explore)
  
  AH_merged <- rbind(AH_mmclock_fmri, AH_mmclock_meg)
  AH_merged <- rbind(AH_merged, AH_explore)
  
  
  PH_merged <- PH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  PH_merged <- PH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  PH_merged$subj_level_rand_slope <- as.factor(PH_merged$subj_level_rand_slope)
  PH_merged <- PH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  PH_merged <- PH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  AH_merged <- AH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  AH_merged <- AH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  AH_merged$subj_level_rand_slope <- as.factor(AH_merged$subj_level_rand_slope)
  AH_merged <- AH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  AH_merged <- AH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  
  AH_summary <- AH_merged %>% 
    group_by(dataset,network,last_outcome,entropy) %>% 
    summarize(mean_trend = mean(rt_vmax_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  PH_summary <- PH_merged %>% 
    group_by(dataset,network,last_outcome,entropy) %>% 
    summarize(mean_trend = mean(rt_vmax_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  
  
  library(wesanderson)
  pal3 = wes_palette("FantasticFox1", 3, type = "discrete")
  pal = palette()
  pal[1] = pal3[2]
  pal[2] = pal3[1]
  pal[3] = pal3[3]
  
  pdf('RT-Pred-3way-Entropy-AH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(AH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(last_outcome~dataset,labeller = label_wrap_gen(width=16), scales='free_y') + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    xlab('Network') +
    ggtitle('Anterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  pdf('RT-Pred-3way-Entropy-PH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(PH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(last_outcome~dataset,labeller = label_wrap_gen(width=16), scales='free_y') + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    xlab('Network') +
    ggtitle('Posterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  
}

if (do_pred_Vmax){
  
  source("~/fmri.pipeline/R/mixed_by.R")
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-ranslopes-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  qdf <- qdf %>% rename(id=level)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf$id <- as.character(qdf$id)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory=repo_directory,dataset='mmclock_fmri')
  df <- df %>% select(rt_vmax_lag,iti_prev,ev,iti_ideal,score_csv,v_max,outcome,v_entropy,rt_lag,v_entropy_full,v_entropy_wi_full,rt_vmax_full,rt_vmax_change_full,rt_csv_sc,rt_csv,id, run, run_trial, last_outcome, trial_neg_inv_sc,pe_max, rt_vmax, score_csv,
                      v_max_wi, v_entropy_wi,kld4_lag,kld4,rt_change,total_earnings, rewFunc,rt_csv, pe_max,v_chosen,rewFunc,iti_ideal,
                      rt_vmax_lag_sc,rt_vmax_change,outcome,pe_max,kld3_lag,rt_lag_sc,rt_next,v_entropy_wi_change,pe_max_lag) %>% 
    group_by(id, run) %>% 
    mutate(iti_lag = lag(iti_ideal), rt_sec = rt_csv/1000) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           iti_sc = scale(iti_ideal),
           iti_prev_sc = scale(iti_prev),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_max_wi_lag = lag(v_max_wi),
           v_entropy_sc = scale(v_entropy),
           v_max_lag_sc = scale(lag(v_max)),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 15 ~ 'Early',
    run_trial > 15 & run_trial < 30 ~ 'Middle',
    run_trial >=30 ~ 'Late',
  )))
  
  df$id <- as.character(df$id)
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)
  #~ (trial_neg_inv + rt_lag + v_max_wi_lag + v_entropy_wi + fmri_beta + last_outcome)^2 +
  #  rt_lag:last_outcome:fmri_beta +
  #  rt_vmax_lag*trial_neg_inv*fmri_beta +
  #  (1 | id/run)
  decode_formula <- NULL
  #decode_formula[[1]] = formula(~ rt_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 | id/run))
  #decode_formula[[2]] = formula(~ rt_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 + rt_lag_sc | id/run))
  #decode_formula[[3]] = formula(~ rt_vmax_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 | id/run))  
  #decode_formula[[4]] = formula(~ rt_vmax_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 + rt_vmax_lag_sc | id/run))   
  
  decode_formula[[1]] <- formula(~(rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * subj_level_rand_slope * last_outcome + (1 | id/run))
  #decode_formula[[2]] <- formula(~(trial_neg_inv_sc + rt_lag_sc + v_max_wi_lag + v_entropy_wi + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * trial_neg_inv_sc * subj_level_rand_slope + (1 + rt_vmax_lag_sc + rt_lag_sc | id/run))
  
  qVL <- quantile(df$v_max_wi_lag,c(0.1,0.9),na.rm=TRUE)
  qRTV <- quantile(df$rt_vmax_lag,c(0.1,0.9),na.rm=TRUE)
  qH <- NULL
  qH[1] <- mean(df$v_entropy_wi,na.rm=TRUE) - 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qH[2] <- mean(df$v_entropy_wi,na.rm=TRUE) + 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRT <- quantile(df$rt_lag_sc,c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  #qH <- c(1,2,3,4)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRS <- quantile(Q2$estimate, c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  splits = c('HC_region','network')
  source('~/fmri.pipeline/R/mixed_by.R')
  for (j in 1:length(decode_formula)){
    
    ddq <- mixed_by(Q2, outcomes = "ev_sc", rhs_model_formulae = decode_formula[[j]], split_on = splits,return_models=TRUE,
                    padjust_by = "term", padjust_method = "fdr", ncores = ncores, refit_on_nonconvergence = 3,
                    tidy_args = list(effects=c("fixed","ran_vals"),conf.int=TRUE),
                    emmeans_spec = list(
                      RT = list(outcome='ev_sc', model_name='model1', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='ev_sc', model_name='model1', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='ev_sc',model_name='model1',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),        
                      RTVxO = list(outcome='ev_sc',model_name='model1',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2)))
                      
                    ),
                    emtrends_spec = list(
                      RT = list(outcome='ev_sc', model_name='model1', var='rt_lag_sc', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='ev_sc', model_name='model1', var='rt_vmax_lag_sc', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='ev_sc',model_name='model1',var='rt_lag_sc',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTVxO = list(outcome='ev_sc',model_name='model1', var = 'rt_vmax_lag_sc',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2)))#,
                      # TrxVmax1 = list(outcome='rt_csv',model_name='model1', var = 'trial_neg_inv_sc',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      # TrxVmax2 = list(outcome='rt_csv',model_name='model1', var = 'subj_level_rand_slope',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(rt_vmax_lag_sc=c(-2,-1,0,1,2),trial_neg_inv_sc=c(-0.9,-0.02,0.2,0.34,0.4)))
                    )
    )
    setwd('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection')
    curr_date <- strftime(Sys.time(),format='%Y-%m-%d')
    if (j==1){
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-pred-ev_sc-int-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata'))
    } else {
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-pred-ev_sc-slo-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata')) 
    }
    
    
    if (do_vif){
      nHC = unique(Q2$HC_region)
      nN = unique(Q2$network)
      vdf <- NULL
      network <- NULL
      HC_region <- NULL
      for (iHC in 1:length(nHC)){
        for (iN in 1:length(nN)){
          temp <- Q2 %>% filter(HC_region == nHC[iHC])
          temp <- temp %>% filter(network == nN[iN])
          m1 <- lmerTest::lmer(data=temp, ev_sc ~(rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * trial_neg_inv_sc * subj_level_rand_slope + (1 | id/run))
          v0 <- car::vif(m1)
          vdf <- rbind(vdf,v0)
          network <- rbind(network,nN[iN])
          HC_region <- rbind(HC_region,nHC[iHC])
        }
      }
      vdf1 <- data.frame(vdf,network=network,HC_regio=HC_region)
    }
  } 
  
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-ranslopes-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  
  ### Does random slope predict rt_vmax or rt_swing?
  rm(Q2)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  #qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf <- qdf %>% rename(id=level)
  qdf$id <- as.character(qdf$id)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory=repo_directory,dataset='mmclock_meg')
  df <- df %>% select(rt_vmax_lag,iti_prev,ev,score_csv,v_max,outcome,v_entropy,rt_lag,v_entropy_full,v_entropy_wi_full,rt_vmax_full,rt_vmax_change_full,rt_csv_sc,rt_csv,id, run, run_trial, last_outcome, trial_neg_inv_sc,pe_max, rt_vmax, score_csv,
                      v_max_wi, v_entropy_wi,kld4_lag,kld4,rt_change,total_earnings, rewFunc,rt_csv, pe_max,v_chosen,rewFunc,
                      rt_vmax_lag_sc,rt_vmax_change,outcome,pe_max,kld3_lag,rt_lag_sc,rt_next,v_entropy_wi_change,pe_max_lag) %>% 
    group_by(id, run) %>% 
    mutate(rt_sec = rt_csv/1000) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_entropy_sc = scale(v_entropy),
           v_max_wi_lag = lag(v_max_wi),
           v_max_lag_sc = scale(lag(v_max)),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 15 ~ 'Early',
    run_trial > 15 & run_trial < 30 ~ 'Middle',
    run_trial >=30 ~ 'Late',
  )))
  
  df$id <- as.character(df$id)
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)
  #~ (trial_neg_inv + rt_lag + v_max_wi_lag + v_entropy_wi + fmri_beta + last_outcome)^2 +
  #  rt_lag:last_outcome:fmri_beta +
  #  rt_vmax_lag*trial_neg_inv*fmri_beta +
  #  (1 | id/run)
  decode_formula <- NULL
  decode_formula[[1]] <- formula(~( rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * subj_level_rand_slope * last_outcome + (1 | id/run))
  #decode_formula[[2]] <- formula(~(trial_neg_inv_sc + rt_lag_sc + v_max_wi_lag + v_entropy_wi + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * trial_neg_inv_sc * subj_level_rand_slope + (1 + rt_vmax_lag_sc + rt_lag_sc | id/run))
  qVL <- quantile(df$v_max_wi_lag,c(0.1,0.9),na.rm=TRUE)
  qRTV <- quantile(df$rt_vmax_lag,c(0.1,0.9),na.rm=TRUE)
  qH <- NULL
  qH[1] <- mean(df$v_entropy_wi,na.rm=TRUE) - 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qH[2] <- mean(df$v_entropy_wi,na.rm=TRUE) + 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRT <- quantile(df$rt_lag_sc,c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  #qH <- c(1,2,3,4)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRS <- quantile(Q2$estimate, c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  splits = c('HC_region','network')
  source('~/fmri.pipeline/R/mixed_by.R')
  for (j in 1:length(decode_formula)){
    ddq <- mixed_by(Q2, outcomes = "ev_sc", rhs_model_formulae = decode_formula[[j]], split_on = splits,return_models=TRUE,
                    padjust_by = "term", padjust_method = "fdr", ncores = ncores, refit_on_nonconvergence = 3,
                    tidy_args = list(effects=c("fixed","ran_vals"),conf.int=TRUE),
                    emmeans_spec = list(
                      RT = list(outcome='ev_sc', model_name='model1', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='ev_sc', model_name='model1', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='ev_sc',model_name='model1',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),        
                      RTVxO = list(outcome='ev_sc',model_name='model1',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2)))
                      
                    ),
                    emtrends_spec = list(
                      RT = list(outcome='ev_sc', model_name='model1', var='rt_lag_sc', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='ev_sc', model_name='model1', var='rt_vmax_lag_sc', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='ev_sc',model_name='model1',var='rt_lag_sc',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTVxO = list(outcome='ev_sc',model_name='model1', var = 'rt_vmax_lag_sc',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2)))#,
                      # TrxVmax1 = list(outcome='rt_csv',model_name='model1', var = 'trial_neg_inv_sc',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      # TrxVmax2 = list(outcome='rt_csv',model_name='model1', var = 'subj_level_rand_slope',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(rt_vmax_lag_sc=c(-2,-1,0,1,2),trial_neg_inv_sc=c(-0.9,-0.02,0.2,0.34,0.4)))
                    )
    )
    setwd('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection')
    curr_date <- strftime(Sys.time(),format='%Y-%m-%d')
    if (j==1){
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-replication-pred-ev_sc-int-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata'))
    } else {
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-replication-pred-ev_sc-slo-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata')) 
    } 
  }
  
  
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-Explore-ranslopes-HConly-trial_mod-trial1-10included-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  
  ### Does random slope predict rt_vmax or rt_swing?
  rm(Q2)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  
  #qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf <- qdf %>% rename(id=level)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf$id <- as.character(qdf$id)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory='/Volumes/Users/Andrew/MEDuSA_data_Explore',dataset='explore')
  df <- df %>%
    group_by(id,run_number) %>%
    arrange(id, run_number, trial) %>%
    mutate(condition_trial = run_trial-floor(run_trial/40.5)*40,
           condition_trial_neg_inv = -1000 / condition_trial,
           condition_trial_neg_inv_sc = as.vector(scale(condition_trial_neg_inv)),
    ) %>% ungroup()
  df <- df %>%
    group_by(id) %>% 
    mutate(v_entropy_sc_r = scale(v_entropy)) %>% ungroup() %>%
    group_by(id, run) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           iti_sc = scale(iti_ideal),
           iti_lag_sc = lag(iti_sc),
           v_chosen_sc = scale(v_chosen),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_entropy_sc = scale(v_entropy),
           v_max_lag_sc = scale(lag(v_max)),
           v_max_wi_lag = lag(v_max_wi),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           abs_rt_vmax_change = abs(rt_vmax_change),
           rt_vmax_change_bin = case_when(
             abs_rt_vmax_change < 4/24 ~ 'No Change',
             abs_rt_vmax_change >= 4/24 ~ 'Change'
           ),
           v_entropy_wi_change_bin = case_when(
             v_entropy_wi_change < -0.5 ~ 'Decrease',
             v_entropy_wi_change > 0.5  ~ 'Increase',
             v_entropy_wi_change >= -0.5 & v_entropy_wi_change <= 0.5 ~ 'No Change'
           ),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 13 ~ 'Early',
    run_trial > 13 & run_trial < 26 ~ 'Middle',
    run_trial >=26 ~ 'Late',
  )))
  df <- df %>% mutate(total_earnings_split = case_when(total_earnings >= median(df$total_earnings,na.rm=TRUE)~'richer',
                                                       total_earnings < median(df$total_earnings,na.rm=TRUE)~'poorer'))
  
  df <- df %>% select(total_earnings_split,v_max_wi_lag,rt_vmax_lag_sc,condition_trial_neg_inv_sc,iti_ideal,rt_lag_sc,iti_lag_sc,iti_prev,iti_sc,v_entropy_wi_change_lag,outcome,ev_sc,v_chosen_sc,last_outcome,rt_csv,rt_bin,rt_vmax_change_sc,trial_bin,rt_csv_sc,run_trial,id,run,v_entropy_wi,v_max_wi,trial_neg_inv_sc,trial,rewFunc)
  df$id <- as.character(df$id)
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)
  Q2 <- Q2 %>% mutate(run_trial0 = case_when(trial <= 40 ~ trial, 
                                             trial > 40 & trial <= 80 ~ trial-40,
                                             trial > 80 & trial <=120 ~ trial-80, 
                                             trial > 120 & trial <=160 ~ trial-120,
                                             trial > 160 & trial <=200 ~ trial-160,
                                             trial > 200 & trial <=240 ~ trial-200))
  Q2 <- Q2 %>% mutate(run_trial0_c = run_trial-floor(run_trial/40.5)*40,
                      run_trial0_neg_inv = -1000 / run_trial0_c,
                      run_trial0_neg_inv_sc = as.vector(scale(run_trial0_neg_inv))
  )
  #~ (trial_neg_inv + rt_lag + v_max_wi_lag + v_entropy_wi + fmri_beta + last_outcome)^2 +
  #  rt_lag:last_outcome:fmri_beta +
  #  rt_vmax_lag*trial_neg_inv*fmri_beta +
  #  (1 | id/run)
  decode_formula <- NULL
  decode_formula[[1]] <- formula(~(rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * subj_level_rand_slope*last_outcome + (1 | id/run))
  qH <- NULL
  qH[1] <- mean(df$v_entropy_wi,na.rm=TRUE) - 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qH[2] <- mean(df$v_entropy_wi,na.rm=TRUE) + 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRT <- quantile(df$rt_lag_sc,c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  #qH <- c(1,2,3,4)
  qT <- quantile(df$condition_trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  splits = c('HC_region','network')
  source('~/fmri.pipeline/R/mixed_by.R')
  for (j in 1:length(decode_formula)){
    ddq <- mixed_by(Q2, outcomes = "ev_sc", rhs_model_formulae = decode_formula[[j]], split_on = splits,return_models=TRUE,
                    padjust_by = "term", padjust_method = "fdr", ncores = ncores, refit_on_nonconvergence = 3,
                    tidy_args = list(effects=c("fixed","ran_vals"),conf.int=TRUE),
                    emmeans_spec = list(
                      RT = list(outcome='ev_sc', model_name='model1', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='ev_sc', model_name='model1', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='ev_sc',model_name='model1',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2),rt_lag_sc=c(-2,-1,0,1,2))),        
                      RTVxO = list(outcome='ev_sc',model_name='model1',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2)))
                      
                    ),
                    emtrends_spec = list(
                      RT = list(outcome='ev_sc', model_name='model1', var='rt_lag_sc', 
                                specs=formula(~rt_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      Vmax = list(outcome='ev_sc', model_name='model1', var='rt_vmax_lag_sc', 
                                  specs=formula(~rt_vmax_lag_sc:subj_level_rand_slope), at = list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTxO = list(outcome='ev_sc',model_name='model1',var='rt_lag_sc',
                                  specs=formula(~rt_lag_sc:last_outcome:subj_level_rand_slope), at=list(subj_level_rand_slope=c(-2,-1,0,1,2))),
                      RTVxO = list(outcome='ev_sc',model_name='model1', var = 'rt_vmax_lag_sc',
                                   specs=formula(~rt_vmax_lag_sc:last_outcome:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2)))#,
                      # TrxVmax1 = list(outcome='rt_csv',model_name='model1', var = 'trial_neg_inv_sc',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(subj_level_rand_slope = c(-2,-1,0,1,2),rt_vmax_lag_sc=c(-2,-1,0,1,2))),
                      # TrxVmax2 = list(outcome='rt_csv',model_name='model1', var = 'subj_level_rand_slope',
                      #                 specs=formula(~rt_vmax_lag_sc:trial_neg_inv_sc:subj_level_rand_slope), at= list(rt_vmax_lag_sc=c(-2,-1,0,1,2),trial_neg_inv_sc=c(-0.9,-0.02,0.2,0.34,0.4)))
                    )
    )
    setwd('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection')
    curr_date <- strftime(Sys.time(),format='%Y-%m-%d')
    if (j==1){
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-Explore-ranslopes-',toalign,'-pred-ev_sc-int-trial_mod-trial1-10included-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata'))
    } else {
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-Explore-ranslopes-',toalign,'-pred-ev_sc-slo-trial_mod-trial1-10included-notimesplit-nofixedeffect-exploit3way-',1,'.Rdata')) 
    }
    
    if (do_vif){
      nHC = unique(Q2$HC_region)
      nN = unique(Q2$network)
      vdf <- NULL
      network <- NULL
      HC_region <- NULL
      for (iHC in 1:length(nHC)){
        for (iN in 1:length(nN)){
          temp <- Q2 %>% filter(HC_region == nHC[iHC])
          temp <- temp %>% filter(network == nN[iN])
          m1 <- lmerTest::lmer(data=temp, ev_sc ~ (rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * subj_level_rand_slope * last_outcome + (1 | id/run))
          v0 <- car::vif(m1)
          vdf <- rbind(vdf,v0)
          network <- rbind(network,nN[iN])
          HC_region <- rbind(HC_region,nHC[iHC])
        }
      }
      vdf2 <- data.frame(vdf,network=network,HC_regio=HC_region)
    }
    
  }
} 

if (plot_pred_Vmax){
  
  # model iterations 1=HC_within:v_entropy, 2=HC_within:v_max_wi, 3=HC_within (not currently reported)
  load('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/2024-07-13-vmPFC-HC-network-ranslopes-clock-pred-ev_sc-int-notimesplit-nofixedeffect-exploit3way-1.Rdata')
  emt_mmclock_fmri <- ddq$emtrends_list
  load('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/2024-07-13-vmPFC-HC-network-ranslopes-clock-replication-pred-ev_sc-int-notimesplit-nofixedeffect-exploit3way-1.Rdata')
  emt_mmclock_meg <- ddq$emtrends_list
  load('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/2024-07-13-vmPFC-HC-network-Explore-ranslopes-clock-pred-ev_sc-int-trial_mod-trial1-10included-notimesplit-nofixedeffect-exploit3way-1.Rdata')
  emt_explore <- ddq$emtrends_list
  
  
  RTxO_mmclock_fmri <- emt_mmclock_fmri$RTxO %>% mutate(dataset = 'Experiment 1 fMRI')
  RTxO_mmclock_meg <- emt_mmclock_meg$RTxO %>% mutate(dataset = 'Experiment 1 MEG')
  RTxO_explore <- emt_explore$RTxO %>% mutate(dataset = 'Experiment 2')
  
  PH_mmclock_fmri <- RTxO_mmclock_fmri %>% filter(HC_region == 'PH')
  PH_mmclock_meg <- RTxO_mmclock_meg %>% filter(HC_region == 'PH')
  PH_explore <- RTxO_explore %>% filter(HC_region == 'PH')
  
  AH_mmclock_fmri <- RTxO_mmclock_fmri %>% filter(HC_region == 'AH')
  AH_mmclock_meg <- RTxO_mmclock_meg %>% filter(HC_region == 'AH')
  AH_explore <- RTxO_explore %>% filter(HC_region == 'AH')
  
  PH_merged <- rbind(PH_mmclock_fmri,PH_mmclock_meg)
  PH_merged <- rbind(PH_merged, PH_explore)
  
  AH_merged <- rbind(AH_mmclock_fmri, AH_mmclock_meg)
  AH_merged <- rbind(AH_merged, AH_explore)
  
  
  PH_merged <- PH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  PH_merged <- PH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  PH_merged$subj_level_rand_slope <- as.factor(PH_merged$subj_level_rand_slope)
  PH_merged <- PH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  PH_merged <- PH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  AH_merged <- AH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  AH_merged <- AH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  AH_merged$subj_level_rand_slope <- as.factor(AH_merged$subj_level_rand_slope)
  AH_merged <- AH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  AH_merged <- AH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  
  AH_summary <- AH_merged %>% 
    group_by(dataset,network,last_outcome,entropy) %>% 
    summarize(mean_trend = mean(rt_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  PH_summary <- PH_merged %>% 
    group_by(dataset,network,last_outcome,entropy) %>% 
    summarize(mean_trend = mean(rt_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  
  
  library(wesanderson)
  pal3 = wes_palette("FantasticFox1", 3, type = "discrete")
  pal = palette()
  pal[1] = pal3[2]
  pal[2] = pal3[1]
  pal[3] = pal3[3]
  
  pdf('Vmax-Pred-Entropy-AH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(AH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(last_outcome~dataset,labeller = label_wrap_gen(width=16), scales='free_y') + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    xlab('Network') +
    ggtitle('Anterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  pdf('Vmax-Pred-Entropy-PH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(PH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(last_outcome~dataset,labeller = label_wrap_gen(width=16), scales='free_y') + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    xlab('Network') +
    ggtitle('Posterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  
  RT_mmclock_fmri <- emt_mmclock_fmri$RT %>% mutate(dataset = 'Experiment 1 fMRI')
  RT_mmclock_meg <- emt_mmclock_meg$RT %>% mutate(dataset = 'Experiment 1 MEG')
  RT_explore <- emt_explore$RT %>% mutate(dataset = 'Experiment 2')
  
  PH_mmclock_fmri <- RT_mmclock_fmri %>% filter(HC_region == 'PH')
  PH_mmclock_meg <- RT_mmclock_meg %>% filter(HC_region == 'PH')
  PH_explore <- RT_explore %>% filter(HC_region == 'PH')
  
  AH_mmclock_fmri <- RT_mmclock_fmri %>% filter(HC_region == 'AH')
  AH_mmclock_meg <- RT_mmclock_meg %>% filter(HC_region == 'AH')
  AH_explore <- RT_explore %>% filter(HC_region == 'AH')
  
  PH_merged <- rbind(PH_mmclock_fmri,PH_mmclock_meg)
  PH_merged <- rbind(PH_merged, PH_explore)
  
  AH_merged <- rbind(AH_mmclock_fmri, AH_mmclock_meg)
  AH_merged <- rbind(AH_merged, AH_explore)
  
  
  PH_merged <- PH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  PH_merged <- PH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  PH_merged$subj_level_rand_slope <- as.factor(PH_merged$subj_level_rand_slope)
  PH_merged <- PH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  PH_merged <- PH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  AH_merged <- AH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  AH_merged <- AH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  AH_merged$subj_level_rand_slope <- as.factor(AH_merged$subj_level_rand_slope)
  AH_merged <- AH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  AH_merged <- AH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  
  AH_summary <- AH_merged %>% 
    group_by(dataset,network,entropy) %>% 
    summarize(mean_trend = mean(rt_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  PH_summary <- PH_merged %>% 
    group_by(dataset,network,entropy) %>% 
    summarize(mean_trend = mean(rt_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  
  
  library(wesanderson)
  pal3 = wes_palette("FantasticFox1", 3, type = "discrete")
  pal = palette()
  pal[1] = pal3[2]
  pal[2] = pal3[1]
  pal[3] = pal3[3]
  
  pdf('Vmax-2way-Pred-Entropy-AH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(AH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(~dataset,labeller = label_wrap_gen(width=16)) + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    ggtitle('Anterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  pdf('Vmax-2way-Pred-Entropy-PH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(PH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(~dataset,labeller = label_wrap_gen(width=16)) + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    ggtitle('Posterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  # RTdmm$p_level_fdr <- factor(RTdmm$p_level_fdr, levels = c('1', '2', '3', '4'), labels = c("NS","p < .05", "p < .01", "p < .001"))
  # ggplot(RTdmm, aes(x=evt_time,y=rt_lag_sc.trend,color=entropy,group=entropy,ymin=rt_lag_sc.trend-std.error,ymax=rt_lag_sc.trend+std.error)) + 
  #   geom_point(size=3) + geom_line(size=1) +
  #   geom_errorbar(width=0.5) + scale_y_reverse() + facet_grid(last_outcome~HC_region) +
  #   ylab('<--- less --- Exploration --- more --->') + ggtitle('DMN emtrend')
  # #ggtitle('Exploration occurs when DMN-HC Connectivity is \n More Modulated by Entropy')
  
  
  RTvmax_mmclock_fmri <- emt_mmclock_fmri$Vmax %>% mutate(dataset = 'Experiment 1 fMRI')
  RTvmax_mmclock_meg <- emt_mmclock_meg$Vmax %>% mutate(dataset = 'Experiment 1 MEG')
  RTvmax_explore <- emt_explore$Vmax %>% mutate(dataset = 'Experiment 2')
  
  PH_mmclock_fmri <- RTvmax_mmclock_fmri %>% filter(HC_region == 'PH')
  PH_mmclock_meg <- RTvmax_mmclock_meg %>% filter(HC_region == 'PH')
  PH_explore <- RTvmax_explore %>% filter(HC_region == 'PH')
  
  AH_mmclock_fmri <- RTvmax_mmclock_fmri %>% filter(HC_region == 'AH')
  AH_mmclock_meg <- RTvmax_mmclock_meg %>% filter(HC_region == 'AH')
  AH_explore <- RTvmax_explore %>% filter(HC_region == 'AH')
  
  PH_merged <- rbind(PH_mmclock_fmri,PH_mmclock_meg)
  PH_merged <- rbind(PH_merged, PH_explore)
  
  AH_merged <- rbind(AH_mmclock_fmri, AH_mmclock_meg)
  AH_merged <- rbind(AH_merged, AH_explore)
  
  
  PH_merged <- PH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  PH_merged <- PH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  PH_merged$subj_level_rand_slope <- as.factor(PH_merged$subj_level_rand_slope)
  PH_merged <- PH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  PH_merged <- PH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  AH_merged <- AH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  AH_merged <- AH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  AH_merged$subj_level_rand_slope <- as.factor(AH_merged$subj_level_rand_slope)
  AH_merged <- AH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  AH_merged <- AH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  
  AH_summary <- AH_merged %>% 
    group_by(dataset,network,entropy) %>% 
    summarize(mean_trend = mean(rt_vmax_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  PH_summary <- PH_merged %>% 
    group_by(dataset,network,entropy) %>% 
    summarize(mean_trend = mean(rt_vmax_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  
  
  library(wesanderson)
  pal3 = wes_palette("FantasticFox1", 3, type = "discrete")
  pal = palette()
  pal[1] = pal3[2]
  pal[2] = pal3[1]
  pal[3] = pal3[3]
  
  pdf('Vmax-RTvmax-2way-Pred-Entropy-AH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(AH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(~dataset,labeller = label_wrap_gen(width=16)) + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploitation - more ->') +
    theme_bw(base_size=13) +
    ggtitle('Anterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  pdf('Vmax-RTvmax-2way-Pred-Entropy-PH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(PH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(~dataset,labeller = label_wrap_gen(width=16)) + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploitation - more ->') +
    theme_bw(base_size=13) +
    ggtitle('Posterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  
  
  RTVxO_mmclock_fmri <- emt_mmclock_fmri$RTVxO %>% mutate(dataset = 'Experiment 1 fMRI')
  RTVxO_mmclock_meg <- emt_mmclock_meg$RTVxO %>% mutate(dataset = 'Experiment 1 MEG')
  RTVxO_explore <- emt_explore$RTVxO %>% mutate(dataset = 'Experiment 2')
  
  PH_mmclock_fmri <- RTVxO_mmclock_fmri %>% filter(HC_region == 'PH')
  PH_mmclock_meg <- RTVxO_mmclock_meg %>% filter(HC_region == 'PH')
  PH_explore <- RTVxO_explore %>% filter(HC_region == 'PH')
  
  AH_mmclock_fmri <- RTVxO_mmclock_fmri %>% filter(HC_region == 'AH')
  AH_mmclock_meg <- RTVxO_mmclock_meg %>% filter(HC_region == 'AH')
  AH_explore <- RTVxO_explore %>% filter(HC_region == 'AH')
  
  PH_merged <- rbind(PH_mmclock_fmri,PH_mmclock_meg)
  PH_merged <- rbind(PH_merged, PH_explore)
  
  AH_merged <- rbind(AH_mmclock_fmri, AH_mmclock_meg)
  AH_merged <- rbind(AH_merged, AH_explore)
  
  
  PH_merged <- PH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  PH_merged <- PH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  PH_merged$subj_level_rand_slope <- as.factor(PH_merged$subj_level_rand_slope)
  PH_merged <- PH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  PH_merged <- PH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  AH_merged <- AH_merged %>% filter((subj_level_rand_slope==-std_of_subject_level_rand_slope | subj_level_rand_slope==std_of_subject_level_rand_slope))
  AH_merged <- AH_merged %>% mutate(padj_fdr_term = p.adjust(p.value,method='bonferroni'))
  AH_merged$subj_level_rand_slope <- as.factor(AH_merged$subj_level_rand_slope)
  AH_merged <- AH_merged  %>% mutate(p_fdr = padj_fdr_term, 
                                     p_level_fdr = as.factor(case_when(
                                       # p_fdr > .1 ~ '0',
                                       # p_fdr < .1 & p_fdr > .05 ~ '1',
                                       p_fdr > .05 ~ '1',
                                       p_fdr < .05 & p_fdr > .01 ~ '2',
                                       p_fdr < .01 & p_fdr > .001 ~ '3',
                                       p_fdr <.001 ~ '4')))
  
  AH_merged <- AH_merged %>% mutate(entropy = case_when(subj_level_rand_slope==-std_of_subject_level_rand_slope ~ '-1 STD',
                                                        subj_level_rand_slope==std_of_subject_level_rand_slope ~ '+1 STD'))
  
  
  
  AH_summary <- AH_merged %>% 
    group_by(dataset,network,last_outcome,entropy) %>% 
    summarize(mean_trend = mean(rt_vmax_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  PH_summary <- PH_merged %>% 
    group_by(dataset,network,last_outcome,entropy) %>% 
    summarize(mean_trend = mean(rt_vmax_lag_sc.trend,na.rm=TRUE), mean_sd = mean(std.error,na.rm=TRUE), sum_p_ls_001 = sum(p_level_fdr =='4')) %>% 
    ungroup() 
  
  
  
  library(wesanderson)
  pal3 = wes_palette("FantasticFox1", 3, type = "discrete")
  pal = palette()
  pal[1] = pal3[2]
  pal[2] = pal3[1]
  pal[3] = pal3[3]
  
  pdf('Vmax-RT-Pred-3way-Entropy-AH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(AH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(last_outcome~dataset,labeller = label_wrap_gen(width=16), scales='free_y') + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    xlab('Network') +
    ggtitle('Anterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  pdf('Vmax-RT-Pred-3way-Entropy-PH-emtrends-Exploit3way.pdf',height=8,width=10)
  gg1 <- ggplot(PH_summary, aes(x=network,y=mean_trend,ymin = mean_trend-mean_sd,ymax=mean_trend+mean_sd,color=network, group=entropy)) + 
    geom_point(size=5, position=position_dodge(width=0.5), aes(shape = entropy)) + 
    geom_errorbar(width=0.1, position=position_dodge(width=0.5),color = 'black') + 
    facet_grid(last_outcome~dataset,labeller = label_wrap_gen(width=16), scales='free_y') + scale_color_manual(values = pal) + 
    scale_shape_manual(values = c(1,16)) +
    ylab('<- less - Exploration - more ->') + scale_y_reverse() +
    theme_bw(base_size=13) +
    xlab('Network') +
    ggtitle('Posterior Hippocampus') +
    theme(legend.title = element_blank(),
          axis.title.y = element_text(margin=margin(r=6),size=22),
          axis.title.x = element_text(margin=margin(t=6),size=22),
          legend.text = element_text(size=22),
          axis.text.y = element_text(size=22),
          panel.spacing = unit(0.25,"lines"),
          strip.text = element_text(size=22),
          axis.text.x = element_text(angle = -45, vjust = 0.6, hjust=0.1, size=22))
  print(gg1)
  dev.off()
  
  
}

if (do_pred_EV){
  
  source("~/fmri.pipeline/R/mixed_by.R")
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-ranslopes-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  qdf <- qdf %>% rename(id=level)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf$id <- as.character(qdf$id)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory=repo_directory,dataset='mmclock_fmri')
  df <- df %>% select(probability,magnitude,rt_vmax_lag,iti_prev,ev,iti_ideal,score_csv,v_max,outcome,v_entropy,rt_lag,v_entropy_full,v_entropy_wi_full,rt_vmax_full,rt_vmax_change_full,rt_csv_sc,rt_csv,id, run, run_trial, last_outcome, trial_neg_inv_sc,pe_max, rt_vmax, score_csv,
                      v_max_wi, v_entropy_wi,kld4_lag,kld4,rt_change,total_earnings, rewFunc,rt_csv, pe_max,v_chosen,rewFunc,iti_ideal,
                      rt_vmax_lag_sc,rt_vmax_change,outcome,pe_max,kld3_lag,rt_lag_sc,rt_next,v_entropy_wi_change,pe_max_lag) %>% 
    group_by(id, run) %>% 
    mutate(iti_lag = lag(iti_ideal), rt_sec = rt_csv/1000) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           iti_sc = scale(iti_ideal),
           iti_prev_sc = scale(iti_prev),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_max_wi_lag = lag(v_max_wi),
           v_entropy_sc = scale(v_entropy),
           v_max_lag_sc = scale(lag(v_max)),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 15 ~ 'Early',
    run_trial > 15 & run_trial < 30 ~ 'Middle',
    run_trial >=30 ~ 'Late',
  )))
  df <- df %>% group_by(id,run) %>% mutate(d_vmax = lag(v_max)) %>% ungroup()
  df$id <- as.character(df$id)
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)
  Q2 <- Q2 %>% filter(!is.na(last_outcome))
  
  #~ (trial_neg_inv + rt_lag + v_max_wi_lag + v_entropy_wi + fmri_beta + last_outcome)^2 +
  #  rt_lag:last_outcome:fmri_beta +
  #  rt_vmax_lag*trial_neg_inv*fmri_beta +
  #  (1 | id/run)
  decode_formula <- NULL
  #decode_formula[[1]] = formula(~ rt_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 | id/run))
  #decode_formula[[2]] = formula(~ rt_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 + rt_lag_sc | id/run))
  #decode_formula[[3]] = formula(~ rt_vmax_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 | id/run))  
  #decode_formula[[4]] = formula(~ rt_vmax_lag_sc*subj_level_rand_slope + iti_sc + iti_prev_sc + last_outcome + outcome + v_entropy_wi + v_max_wi +  (1 + rt_vmax_lag_sc | id/run))   
  
  decode_formula[[1]] <- formula(~subj_level_rand_slope*last_outcome + trial_neg_inv_sc + v_entropy_wi + v_max_wi + (1|id))
  #decode_formula[[2]] <- formula(~(trial_neg_inv_sc + rt_lag_sc + v_max_wi_lag + v_entropy_wi + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * trial_neg_inv_sc * subj_level_rand_slope + (1 + rt_vmax_lag_sc + rt_lag_sc | id/run))
  
  qVL <- quantile(df$v_max_wi_lag,c(0.1,0.9),na.rm=TRUE)
  qRTV <- quantile(df$rt_vmax_lag,c(0.1,0.9),na.rm=TRUE)
  qH <- NULL
  qH[1] <- mean(df$v_entropy_wi,na.rm=TRUE) - 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qH[2] <- mean(df$v_entropy_wi,na.rm=TRUE) + 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRT <- quantile(df$rt_lag_sc,c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  #qH <- c(1,2,3,4)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRS <- quantile(Q2$estimate, c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  splits = c('HC_region','network')
  source('~/fmri.pipeline/R/mixed_by.R')
  for (j in 1:length(decode_formula)){
    
    ddq <- mixed_by(Q2, outcomes = "ev", rhs_model_formulae = decode_formula[[j]], split_on = splits,return_models=TRUE,
                    padjust_by = "term", padjust_method = "fdr", ncores = ncores, refit_on_nonconvergence = 3,
                    tidy_args = list(effects=c("fixed","ran_vals"),conf.int=TRUE),
                    emmeans_spec = list(
                      RT = list(outcome='ev', model_name='model1', 
                                specs=formula(~subj_level_rand_slope:last_outcome), at = list(subj_level_rand_slope=c(-2,-1,0,1,2)))
                    ),
                    emtrends_spec = list(
                      RT = list(outcome='ev', model_name='model1', var='subj_level_rand_slope', 
                                specs=formula(~subj_level_rand_slope:last_outcome), at = list(subj_level_rand_slope=c(-2,-1,0,1,2)))
                    )
    )
    setwd('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection')
    curr_date <- strftime(Sys.time(),format='%Y-%m-%d')
    if (j==1){
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-pred-ev-int-notimesplit-nofixedeffect-',1,'.Rdata'))
    } else {
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-pred-ev-slo-notimesplit-nofixedeffect-',1,'.Rdata')) 
    }
    
    
    if (do_vif){
      nHC = unique(Q2$HC_region)
      nN = unique(Q2$network)
      vdf <- NULL
      network <- NULL
      HC_region <- NULL
      for (iHC in 1:length(nHC)){
        for (iN in 1:length(nN)){
          temp <- Q2 %>% filter(HC_region == nHC[iHC])
          temp <- temp %>% filter(network == nN[iN])
          m1 <- lmerTest::lmer(data=temp, ev ~ subj_level_rand_slope*last_outcome + trial_neg_inv_sc + v_entropy_wi + v_max_wi + (1|id))
          v0 <- car::vif(m1)
          vdf <- rbind(vdf,v0)
          network <- rbind(network,nN[iN])
          HC_region <- rbind(HC_region,nHC[iHC])
        }
      }
      vdf1 <- data.frame(vdf,network=network,HC_regio=HC_region)
    }
  } 
  
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-ranslopes-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  
  ### Does random slope predict rt_vmax or rt_swing?
  rm(Q2)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  #qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf <- qdf %>% rename(id=level)
  qdf$id <- as.character(qdf$id)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory=repo_directory,dataset='mmclock_meg')
  df <- df %>% select(probability,magnitude,rt_vmax_lag,iti_prev,ev,score_csv,v_max,outcome,v_entropy,rt_lag,v_entropy_full,v_entropy_wi_full,rt_vmax_full,rt_vmax_change_full,rt_csv_sc,rt_csv,id, run, run_trial, last_outcome, trial_neg_inv_sc,pe_max, rt_vmax, score_csv,
                      v_max_wi, v_entropy_wi,kld4_lag,kld4,rt_change,total_earnings, rewFunc,rt_csv, pe_max,v_chosen,rewFunc,
                      rt_vmax_lag_sc,rt_vmax_change,outcome,pe_max,kld3_lag,rt_lag_sc,rt_next,v_entropy_wi_change,pe_max_lag) %>% 
    group_by(id, run) %>% 
    mutate(rt_sec = rt_csv/1000) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_entropy_sc = scale(v_entropy),
           v_max_wi_lag = lag(v_max_wi),
           v_max_lag_sc = scale(lag(v_max)),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 15 ~ 'Early',
    run_trial > 15 & run_trial < 30 ~ 'Middle',
    run_trial >=30 ~ 'Late',
  )))
  df <- df %>% group_by(id,run) %>% mutate(d_vmax = lag(v_max)) %>% ungroup()
  df$id <- as.character(df$id)
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)
  Q2 <- Q2 %>% filter(!is.na(last_outcome))
  #~ (trial_neg_inv + rt_lag + v_max_wi_lag + v_entropy_wi + fmri_beta + last_outcome)^2 +
  #  rt_lag:last_outcome:fmri_beta +
  #  rt_vmax_lag*trial_neg_inv*fmri_beta +
  #  (1 | id/run)
  decode_formula <- NULL
  #decode_formula[[1]] <- formula(~( rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * subj_level_rand_slope * last_outcome + (1 | id/run))
  decode_formula[[1]] <- formula(~subj_level_rand_slope*last_outcome + trial_neg_inv_sc + v_entropy_wi + v_max_wi + (1|id))
  #decode_formula[[2]] <- formula(~(trial_neg_inv_sc + rt_lag_sc + v_max_wi_lag + v_entropy_wi + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * trial_neg_inv_sc * subj_level_rand_slope + (1 + rt_vmax_lag_sc + rt_lag_sc | id/run))
  qVL <- quantile(df$v_max_wi_lag,c(0.1,0.9),na.rm=TRUE)
  qRTV <- quantile(df$rt_vmax_lag,c(0.1,0.9),na.rm=TRUE)
  qH <- NULL
  qH[1] <- mean(df$v_entropy_wi,na.rm=TRUE) - 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qH[2] <- mean(df$v_entropy_wi,na.rm=TRUE) + 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRT <- quantile(df$rt_lag_sc,c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  #qH <- c(1,2,3,4)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRS <- quantile(Q2$estimate, c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  splits = c('HC_region','network')
  source('~/fmri.pipeline/R/mixed_by.R')
  for (j in 1:length(decode_formula)){
    ddq <- mixed_by(Q2, outcomes = "ev", rhs_model_formulae = decode_formula[[j]], split_on = splits,return_models=TRUE,
                    padjust_by = "term", padjust_method = "fdr", ncores = ncores, refit_on_nonconvergence = 3,
                    tidy_args = list(effects=c("fixed","ran_vals"),conf.int=TRUE),
                    emmeans_spec = list(
                      RT = list(outcome='ev', model_name='model1', 
                                specs=formula(~subj_level_rand_slope:last_outcome), at = list(subj_level_rand_slope=c(-2,-1,0,1,2)))
                    ),
                    emtrends_spec = list(
                      RT = list(outcome='ev', model_name='model1', var='subj_level_rand_slope', 
                                specs=formula(~subj_level_rand_slope:last_outcome), at = list(subj_level_rand_slope=c(-2,-1,0,1,2)))
                    )
    )
    setwd('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection')
    curr_date <- strftime(Sys.time(),format='%Y-%m-%d')
    if (j==1){
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-replication-pred-ev-int-notimesplit-nofixedeffect-',1,'.Rdata'))
    } else {
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-ranslopes-',toalign,'-replication-pred-ev-slo-notimesplit-nofixedeffect-',1,'.Rdata')) 
    } 
  }
  
  
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-Explore-ranslopes-HConly-trial_mod-trial1-10included-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  
  ### Does random slope predict rt_vmax or rt_swing?
  rm(Q2)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  
  #qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf <- qdf %>% rename(id=level)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf$id <- as.character(qdf$id)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory='/Volumes/Users/Andrew/MEDuSA_data_Explore',dataset='explore')
  df <- df %>%
    group_by(id,run_number) %>%
    arrange(id, run_number, trial) %>%
    mutate(condition_trial = run_trial-floor(run_trial/40.5)*40,
           condition_trial_neg_inv = -1000 / condition_trial,
           condition_trial_neg_inv_sc = as.vector(scale(condition_trial_neg_inv)),
    ) %>% ungroup()
  df <- df %>%
    group_by(id) %>% 
    mutate(v_entropy_sc_r = scale(v_entropy)) %>% ungroup() %>%
    group_by(id, run) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           iti_sc = scale(iti_ideal),
           iti_lag_sc = lag(iti_sc),
           v_chosen_sc = scale(v_chosen),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_entropy_sc = scale(v_entropy),
           v_max_lag_sc = scale(lag(v_max)),
           v_max_wi_lag = lag(v_max_wi),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           abs_rt_vmax_change = abs(rt_vmax_change),
           rt_vmax_change_bin = case_when(
             abs_rt_vmax_change < 4/24 ~ 'No Change',
             abs_rt_vmax_change >= 4/24 ~ 'Change'
           ),
           v_entropy_wi_change_bin = case_when(
             v_entropy_wi_change < -0.5 ~ 'Decrease',
             v_entropy_wi_change > 0.5  ~ 'Increase',
             v_entropy_wi_change >= -0.5 & v_entropy_wi_change <= 0.5 ~ 'No Change'
           ),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 13 ~ 'Early',
    run_trial > 13 & run_trial < 26 ~ 'Middle',
    run_trial >=26 ~ 'Late',
  )))
  df <- df %>% mutate(total_earnings_split = case_when(total_earnings >= median(df$total_earnings,na.rm=TRUE)~'richer',
                                                       total_earnings < median(df$total_earnings,na.rm=TRUE)~'poorer'))
  
  df <- df %>% select(total_earnings,v_chosen,v_max,probability,magnitude,ev,total_earnings_split,v_max_wi_lag,rt_vmax_lag_sc,condition_trial_neg_inv_sc,iti_ideal,rt_lag_sc,iti_lag_sc,iti_prev,iti_sc,v_entropy_wi_change_lag,outcome,ev_sc,v_chosen_sc,last_outcome,rt_csv,rt_bin,rt_vmax_change_sc,trial_bin,rt_csv_sc,run_trial,id,run,v_entropy_wi,v_max_wi,trial_neg_inv_sc,trial,rewFunc)
  df$id <- as.character(df$id)
  df <- df %>% group_by(id,run) %>% mutate(d_vmax = lag(v_max)) %>% ungroup()
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)
  Q2 <- Q2 %>% mutate(run_trial0 = case_when(trial <= 40 ~ trial, 
                                             trial > 40 & trial <= 80 ~ trial-40,
                                             trial > 80 & trial <=120 ~ trial-80, 
                                             trial > 120 & trial <=160 ~ trial-120,
                                             trial > 160 & trial <=200 ~ trial-160,
                                             trial > 200 & trial <=240 ~ trial-200))
  Q2 <- Q2 %>% mutate(run_trial0_c = run_trial-floor(run_trial/40.5)*40,
                      run_trial0_neg_inv = -1000 / run_trial0_c,
                      run_trial0_neg_inv_sc = as.vector(scale(run_trial0_neg_inv))
  )
  #~ (trial_neg_inv + rt_lag + v_max_wi_lag + v_entropy_wi + fmri_beta + last_outcome)^2 +
  #  rt_lag:last_outcome:fmri_beta +
  #  rt_vmax_lag*trial_neg_inv*fmri_beta +
  #  (1 | id/run)
  decode_formula <- NULL
  #decode_formula[[1]] <- formula(~(rt_lag_sc + subj_level_rand_slope + last_outcome)^2 + rt_lag_sc:last_outcome:subj_level_rand_slope + rt_vmax_lag_sc * subj_level_rand_slope*last_outcome + (1 | id/run))
  decode_formula[[1]] <- formula(~subj_level_rand_slope*last_outcome*rt_lag_sc + run_trial0_neg_inv_sc + v_entropy_wi + v_max_wi + (1|id))
  qH <- NULL
  qH[1] <- mean(df$v_entropy_wi,na.rm=TRUE) - 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qH[2] <- mean(df$v_entropy_wi,na.rm=TRUE) + 2*sd(df$v_entropy_wi,na.rm=TRUE)
  qT <- quantile(df$trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  qRT <- quantile(df$rt_lag_sc,c(0.1,0.25,0.5,0.75,0.9),na.rm=TRUE)
  #qH <- c(1,2,3,4)
  qT <- quantile(df$condition_trial_neg_inv_sc,c(0.1,0.9),na.rm=TRUE)
  splits = c('HC_region','network')
  source('~/fmri.pipeline/R/mixed_by.R')
  for (j in 1:length(decode_formula)){
    ddq <- mixed_by(Q2, outcomes = "magnitude", rhs_model_formulae = decode_formula[[j]], split_on = splits,return_models=TRUE,
                    padjust_by = "term", padjust_method = "fdr", ncores = ncores, refit_on_nonconvergence = 3,
                    tidy_args = list(effects=c("fixed","ran_vals"),conf.int=TRUE),
                    emmeans_spec = list(
                      RT = list(outcome='magnitude', model_name='model1', 
                                specs=formula(~subj_level_rand_slope:last_outcome:rt_lag_sc), at = list(subj_level_rand_slope=c(-2,-1,0,1,2)))
                    ),
                     emtrends_spec = list(
                       RT = list(outcome='magnitude', model_name='model1', var='subj_level_rand_slope', 
                                 specs=formula(~subj_level_rand_slope:last_outcome:rt_lag_sc), at = list(subj_level_rand_slope=c(-2,-1,0,1,2)))
                     )
    )
    setwd('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection')
    curr_date <- strftime(Sys.time(),format='%Y-%m-%d')
    if (j==1){
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-Explore-ranslopes-',toalign,'-pred-magnitude-int-trial_mod-trial1-10included-notimesplit-nofixedeffect-',1,'.Rdata'))
    } else {
      save(ddq,file=paste0(curr_date,'-vmPFC-HC-network-Explore-ranslopes-',toalign,'-pred-ev-slo-trial_mod-trial1-10included-notimesplit-nofixedeffect-',1,'.Rdata')) 
    }
    
    if (do_vif){
      nHC = unique(Q2$HC_region)
      nN = unique(Q2$network)
      vdf <- NULL
      network <- NULL
      HC_region <- NULL
      for (iHC in 1:length(nHC)){
        for (iN in 1:length(nN)){
          temp <- Q2 %>% filter(HC_region == nHC[iHC])
          temp <- temp %>% filter(network == nN[iN])
          m1 <- lmerTest::lmer(data=temp, ev ~ subj_level_rand_slope*rt_lag_sc + run_trial0_neg_inv_sc + v_entropy_wi + v_max_wi + (1|id))
          v0 <- car::vif(m1)
          vdf <- rbind(vdf,v0)
          network <- rbind(network,nN[iN])
          HC_region <- rbind(HC_region,nHC[iHC])
        }
      }
      vdf2 <- data.frame(vdf,network=network,HC_region=HC_region)
    }
    
  }
} 

if (plot_pred_EV){
  # model iterations 1=HC_within:v_entropy, 2=HC_within:v_max_wi, 3=HC_within (not currently reported)
  load('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/2024-07-14-vmPFC-HC-network-ranslopes-clock-pred-ev-int-notimesplit-nofixedeffect-1.Rdata')
  #df1 <- ddq$coef_df_reml %>% filter(term=="subj_level_rand_slope:rt_lag_sc" & last_outcome == "Omission")
  df1 <- ddq$coef_df_reml %>% filter(term=="subj_level_rand_slope:last_outcomeReward")
  emt_mmclock_fmri <- ddq$emtrends_list
  load('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/2024-07-14-vmPFC-HC-network-ranslopes-clock-replication-pred-ev-int-notimesplit-nofixedeffect-1.Rdata')
  #df2 <- ddq$coef_df_reml %>% filter(term=="subj_level_rand_slope:rt_lag_sc" & last_outcome == "Omission")
  df2 <- ddq$coef_df_reml %>% filter(term=="subj_level_rand_slope:last_outcomeReward")
  emt_mmclock_meg <- ddq$emtrends_list
  load('/Users/dnplserv/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/2024-07-14-vmPFC-HC-network-Explore-ranslopes-clock-pred-ev-int-trial_mod-trial1-10included-notimesplit-nofixedeffect-1.Rdata')
  #df3 <- ddq$coef_df_reml %>% filter(term=="subj_level_rand_slope:rt_lag_sc" & last_outcome == "Omission")
  df3 <- ddq$coef_df_reml %>% filter(term=="subj_level_rand_slope:last_outcomeReward")
  emt_explore <- ddq$emtrends_list
  
}

if (do_pred_points){
  source("~/fmri.pipeline/R/mixed_by.R")
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-ranslopes-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  qdf <- qdf %>% rename(id=level)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf$id <- as.character(qdf$id)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory=repo_directory,dataset='mmclock_fmri')
  df <- df %>% select(probability,magnitude,rt_vmax_lag,iti_prev,ev,iti_ideal,score_csv,v_max,outcome,v_entropy,rt_lag,v_entropy_full,v_entropy_wi_full,rt_vmax_full,rt_vmax_change_full,rt_csv_sc,rt_csv,id, run, run_trial, last_outcome, trial_neg_inv_sc,pe_max, rt_vmax, score_csv,
                      v_max_wi, v_entropy_wi,kld4_lag,kld4,rt_change,total_earnings, rewFunc,rt_csv, pe_max,v_chosen,rewFunc,iti_ideal,
                      rt_vmax_lag_sc,rt_vmax_change,outcome,pe_max,kld3_lag,rt_lag_sc,rt_next,v_entropy_wi_change,pe_max_lag) %>% 
    group_by(id, run) %>% 
    mutate(iti_lag = lag(iti_ideal), rt_sec = rt_csv/1000) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           iti_sc = scale(iti_ideal),
           iti_prev_sc = scale(iti_prev),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_max_wi_lag = lag(v_max_wi),
           v_entropy_sc = scale(v_entropy),
           v_max_lag_sc = scale(lag(v_max)),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 15 ~ 'Early',
    run_trial > 15 & run_trial < 30 ~ 'Middle',
    run_trial >=30 ~ 'Late',
  )))
  
  df$id <- as.character(df$id)
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)

  # test age & sex
  demo <- read.table(file=file.path(repo_directory, 'fmri/data/mmy3_demographics.tsv'),sep='\t',header=TRUE)
  demo <- demo %>% rename(id=lunaid)
  demo <- demo %>% select(!adult & !scandate)
  demo$id <- as.character(demo$id)
  Q2 <- inner_join(Q2,demo,by=c('id'))
  Q2$female <- relevel(as.factor(Q2$female),ref='0')
  Q2$age <- scale(Q2$age)
  Q3 <- Q2 %>% group_by(id,network,HC_region) %>% 
    summarize(subj_level_rand_slope = unique(subj_level_rand_slope),sum_last_outcomeOmission = sum(last_outcome=="Omission",na.rm=TRUE), total_earnings = unique(total_earnings), age=unique(age), gender=unique(female)) %>% 
    ungroup()
  mAH_DMN_mmclock_fmri <- lm(data=Q3 %>% filter(HC_region=='AH' & network=='DMN'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  mAH_LIM_mmclock_fmri <- lm(data=Q3 %>% filter(HC_region=='AH' & network=='LIM'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  mAH_CTR_mmclock_fmri <- lm(data=Q3 %>% filter(HC_region=='AH' & network=='CTR'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  mPH_DMN_mmclock_fmri <- lm(data=Q3 %>% filter(HC_region=='PH' & network=='DMN'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  mPH_LIM_mmclock_fmri <- lm(data=Q3 %>% filter(HC_region=='PH' & network=='LIM'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  mPH_CTR_mmclock_fmri <- lm(data=Q3 %>% filter(HC_region=='PH' & network=='CTR'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  
  setwd('~/vmPFC/MEDUSA Schaefer Analysis/vmPFC_HC_model_selection/')
  model_str <- paste0('-vmPFC-HC-network-',toalign,'-Explore-ranslopes-HConly-trial_mod-trial1-10included-nofixedeffect-',1,'.Rdata')
  model_str <- Sys.glob(paste0('*',model_str))
  load(model_str)
  qdf <- ddf$coef_df_reml %>% filter(effect=='ran_vals' & term=='HCwithin:v_entropy_wi')
  #qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf <- qdf %>% rename(id=level)
  qdf <- qdf %>% group_by(id,network,HC_region) %>% summarize(estimate = mean(estimate,na.rm=TRUE)) %>% ungroup()
  qdf <- qdf %>% group_by(network,HC_region) %>% mutate(estimate1 = scale(estimate)) %>% ungroup() %>% select(!estimate) %>% rename(estimate=estimate1)
  qdf$id <- as.character(qdf$id)
  #qdf <- qdf %>% select(!outcome)
  source('/Users/dnplserv/clock_analysis/fmri/keuka_brain_behavior_analyses/dan/get_trial_data.R')
  df <- get_trial_data(repo_directory='/Volumes/Users/Andrew/MEDuSA_data_Explore',dataset='explore')
  df <- df %>%
    group_by(id,run_number) %>%
    arrange(id, run_number, trial) %>%
    mutate(condition_trial = run_trial-floor(run_trial/40.5)*40,
           condition_trial_neg_inv = -1000 / condition_trial,
           condition_trial_neg_inv_sc = as.vector(scale(condition_trial_neg_inv)),
    ) %>% ungroup()
  df <- df %>%
    group_by(id) %>% 
    mutate(v_entropy_sc_r = scale(v_entropy)) %>% ungroup() %>%
    group_by(id, run) %>% 
    mutate(v_chosen_sc = scale(v_chosen),
           abs_pe_max_sc = scale(abs(pe_max)),
           score_sc = scale(score_csv),
           iti_sc = scale(iti_ideal),
           iti_lag_sc = lag(iti_sc),
           v_chosen_sc = scale(v_chosen),
           pe_max_sc = scale(pe_max),
           pe_max_lag_sc = scale(lag(pe_max)),
           abs_pe_max_lag_sc = scale(abs(pe_max_lag)),
           rt_vmax_sc = scale(rt_vmax),
           ev_sc = scale(ev),
           v_entropy_sc = scale(v_entropy),
           v_max_lag_sc = scale(lag(v_max)),
           v_max_wi_lag = lag(v_max_wi),
           v_entropy_wi_change_lag = lag(v_entropy_wi_change),
           abs_rt_vmax_change = abs(rt_vmax_change),
           rt_vmax_change_bin = case_when(
             abs_rt_vmax_change < 4/24 ~ 'No Change',
             abs_rt_vmax_change >= 4/24 ~ 'Change'
           ),
           v_entropy_wi_change_bin = case_when(
             v_entropy_wi_change < -0.5 ~ 'Decrease',
             v_entropy_wi_change > 0.5  ~ 'Increase',
             v_entropy_wi_change >= -0.5 & v_entropy_wi_change <= 0.5 ~ 'No Change'
           ),
           rt_vmax_change_sc = scale(rt_vmax_change)) %>% arrange(id, run, run_trial) %>% mutate(log10kld4 = case_when(
             kld4 ==0 ~ NA_real_,
             kld4 >0 ~ log10(kld4)
           )) %>% mutate(log10kld4_lag = case_when(
             kld4_lag==0 ~NA_real_,
             kld4_lag>0 ~ log10(kld4_lag)
           ))
  df <- df %>% group_by(id,run) %>% mutate(expl_longer =(case_when(
    rt_csv - rt_lag > 1 ~ 'Longer',
    rt_csv - rt_lag < -1 ~ '0',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run) %>% mutate(expl_shorter =(case_when(
    rt_csv - rt_lag > 1 ~ '0',
    rt_csv - rt_lag < -1 ~ 'Shorter',
    rt_csv - rt_lag < 1 & rt_csv - rt_lag > -1 ~ '0'
  )))
  df <- df %>% group_by(id,run)  %>% mutate(rt_bin = (case_when(
    rt_csv_sc <= -1 ~ '-1',
    rt_csv_sc > -1 & rt_csv_sc <= 0 ~ '-0.5',
    rt_csv_sc > 0 & rt_csv_sc <= 1 ~ '0.5',
    rt_csv_sc > 1 ~ '1'
  )))
  df <- df %>% group_by(id,run) %>% mutate(trial_bin = (case_when(
    run_trial <= 13 ~ 'Early',
    run_trial > 13 & run_trial < 26 ~ 'Middle',
    run_trial >=26 ~ 'Late',
  )))
  df <- df %>% mutate(total_earnings_split = case_when(total_earnings >= median(df$total_earnings,na.rm=TRUE)~'richer',
                                                       total_earnings < median(df$total_earnings,na.rm=TRUE)~'poorer'))
  
  df$id <- as.character(df$id)
  Q2 <- inner_join(qdf,df,by='id')
  
  Q2$trial_bin <- factor(Q2$trial_bin)
  Q2$trial_bin <- relevel(Q2$trial_bin, ref='Middle')
  Q2 <- Q2 %>% rename(subj_level_rand_slope=estimate)
  Q2 <- Q2 %>% mutate(run_trial0 = case_when(trial <= 40 ~ trial, 
                                             trial > 40 & trial <= 80 ~ trial-40,
                                             trial > 80 & trial <=120 ~ trial-80, 
                                             trial > 120 & trial <=160 ~ trial-120,
                                             trial > 160 & trial <=200 ~ trial-160,
                                             trial > 200 & trial <=240 ~ trial-200))
  Q2 <- Q2 %>% mutate(run_trial0_c = run_trial-floor(run_trial/40.5)*40,
                      run_trial0_neg_inv = -1000 / run_trial0_c,
                      run_trial0_neg_inv_sc = as.vector(scale(run_trial0_neg_inv))
  )
  demo <- readRDS('/Volumes/Users/Andrew/MEDuSA_data_Explore/explore_n146.rds')
  demo <- demo %>% select(!id)
  demo <- demo %>% rename(id=registration_redcapid,group=registration_group)
  demo$gender <- relevel(as.factor(demo$gender),ref='M')
  demo$age <- scale(demo$age)
  demo$wtar <- scale(demo$wtar)
  demo$education_yrs <- scale(demo$education_yrs)
  demo$id <- as.character(demo$id)
  Q2 <- inner_join(Q2, demo, by=c('id'))
  
  Q3 <- Q2 %>% group_by(id,network,HC_region) %>% 
    summarize(subj_level_rand_slope = unique(subj_level_rand_slope),sum_last_outcomeOmission = sum(last_outcome=="Omission",na.rm=TRUE), total_earnings = unique(total_earnings), age=unique(age), gender=unique(gender)) %>% 
    ungroup()
  mAH_DMN_explore <- lm(data=Q3 %>% filter(HC_region=='AH' & network=='DMN'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  mAH_LIM_explore <- lm(data=Q3 %>% filter(HC_region=='AH' & network=='LIM'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  mAH_CTR_explore <- lm(data=Q3 %>% filter(HC_region=='AH' & network=='CTR'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  mPH_DMN_explore <- lm(data=Q3 %>% filter(HC_region=='PH' & network=='DMN'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  mPH_LIM_explore <- lm(data=Q3 %>% filter(HC_region=='PH' & network=='LIM'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  mPH_CTR_explore <- lm(data=Q3 %>% filter(HC_region=='PH' & network=='CTR'),total_earnings ~ subj_level_rand_slope*sum_last_outcomeOmission + age + gender)
  
  
  
}

